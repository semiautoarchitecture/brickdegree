<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.2.3/showdown.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/3.4.0/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prefixfree/1.0.7/prefixfree.min.js"></script>
<script src="libs/compass.js"></script>
<script src="libs/chroma.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/compass.css">

<script>
var getUrlValue = function(VarSearch){
    var SearchString = window.location.search.substring(1);
    var VariableArray = SearchString.split('&');
    for(var i = 0; i < VariableArray.length; i++){
        var KeyValuePair = VariableArray[i].split('=');
        if(KeyValuePair[0] === VarSearch){
            return KeyValuePair[1];
        }
    }
}
</script>

<title>brickdegree</title>

<script>

var DEBUG = 0;
var degrees;
var degreeIndex = 0;
var courseIndex = 1; //courses start at 1
var brickIndex = 0;

var colorSuccess = 	"#F7F600"; 
var colorNot = "#0075DC";
var colorNextButtonPress = "#3CE400";
var colorNextButtonDontPress = "#222222";

var angleTolerance = 1;

//viridis color mapping
//from https://bids.github.io/colormap/images/screenshots/parula.png
var viridis = ['#352C98', '#0075DC', '#00A7C6', '#27B8A0', '#CCBC53', '#FFC31B'];
var colorScaleFunction = chroma.scale(viridis).domain([180,0]).mode('lab');


function debugPrint(selector, string) {
	if (DEBUG) {
		$(selector).html(string);
	}
}

function angleDiff(angA, angB) {
	var diff = angA - angB;
	diff = Math.abs((diff + 180) % 360 - 180);
	return diff
}

function currentDegree() {
    if(degrees !== undefined) {
        return degrees[degreeIndex];
    } else {
        return -1;
    }

}

function setDegree(increment) {
	degreeIndex += increment;

    var targetDegree = currentDegree();

	if (targetDegree >= 0) {
		brickIndex += 1; //bricks start at 1
		$(".targetdegree").html(targetDegree + "&deg;<br>Course #" + courseIndex + "<br>Brick #" + brickIndex + "<br>(op" + degreeIndex + ")");
		$(".target").css({
			opacity: 1,
			transform: "rotate(" + (-1 * targetDegree) + "deg)"
		});
		$(".targetdegree").css({
			'background-color': 'white',
			color: 'black'
		})
	} else {
		/* NEW COURSE*/
		courseIndex += increment;
		brickIndex = 0;

		$(".target").css({
			opacity: 0,
		});
		$(".targetdegree").html("Course #" + courseIndex + "<br>NEW COURSE");
		$(".targetdegree").css({
			'background-color': 'black',
			color: 'white'
		})
	}
}


function startWebSocket() {

    window.ws = new WebSocket("ws://192.168.1.36:8001/");

    window.ws.onopen = function() {
      window.ws.send("Hello Mr. Server!");
    };

    window.ws.onmessage = function (e) { 
        console.log(e);
        console.log(e.data); 
    };

    window.ws.onclose = function() { };

}

function sendMessage(msg) {
  window.ws.send(msg);
}

$(function() {

    startWebSocket();


	var filename = getUrlValue("filename");

	$.getJSON(filename, function( json ) {
		degrees = json;
		setDegree(0);
	});

	$(".nextbutton").click(function() {
		setDegree(1);
		$(".flashdiv").fadeIn(200).fadeOut(200)
	});

	$(".prevbutton").click(function() {
		setDegree(-1);
	});

});

/* compass */
$(window).load(function() {

	console.log ("window loaded");


    function setCompassBearing(bearing) {

        sendMessage(bearing);

        var degval = $(".degrees .value");

        degval.text(Math.round(bearing * 10 )/ 10);

        var svgDoc = $("#compasses")[0].contentDocument;

        var compasses_info = {};
        compasses_info.s = {};
        compasses_info.s.cx = $("g#compass-s circle", svgDoc).attr("cx");
        compasses_info.s.cy = $("g#compass-s circle", svgDoc).attr("cy");
        compasses_info.m = {};
        compasses_info.m.cx = $("g#compass-m circle", svgDoc).attr("cx");
        compasses_info.m.cy = $("g#compass-m circle", svgDoc).attr("cy");
        compasses_info.l = {};
        compasses_info.l.cx = $("g#compass-l circle", svgDoc).attr("cx");
        compasses_info.l.cy = $("g#compass-l circle", svgDoc).attr("cy");

        //console.log(compasses_info);

        $("g#compass-s", svgDoc).attr({
            transform: "rotate(" + -bearing + " " + compasses_info.s.cx + " " + compasses_info.s.cy + ")"
        });
        $("g#compass-m", svgDoc).attr({
            transform: "rotate(" + -bearing + " " + compasses_info.m.cx + " " + compasses_info.m.cy + ")"
        });
        $("g#compass-l", svgDoc).attr({
            transform: "rotate(" + -bearing + " " + compasses_info.l.cx + " " + compasses_info.l.cy + ")"
        });

        var diff = angleDiff(bearing , currentDegree());
        
        debugPrint(".debug2", diff);

        if(diff < (angleTolerance / 2)) {
            $(".targetdegree").css("background-color", colorSuccess);
            $(".flexcontainer").css("background-color", colorSuccess);
            $(".nextbutton").css("background-color", colorNextButtonPress);
        } else {
            debugPrint(".debug", bearing + " / " + currentDegree() + " / " + diff + " <br>");

            var colorMixed = colorScaleFunction(diff);
            $(".targetdegree").css("background-color", colorNot)
            $(".flexcontainer").css("background-color", colorMixed)
            $(".nextbutton").css("background-color", colorNextButtonDontPress);
        }
    }

	
	Compass.noSupport(function() {
		$(".errormessage").html("You need to access this website on your phone.");
        $(".errordiv").css('display', 'flex');

        window.bearing_debug = 0;
        window.setInterval(function() {
            window.bearing_debug = (window.bearing_debug + 1) % 360;
            setCompassBearing(window.bearing_debug);
        }, 10);

	}).needGPS(function() {
		$(".errormessage").html("You need to enable GPS or Location Services on your phone.");
		$(".errordiv").css('display', 'flex');
	}).needMove(function() {
	}).init(function(e) {
	});

    Compass.watch(function(bearing) {
        setCompassBearing(bearing);
    });
    
    
}); 
</script>

</head>
<body>
<div class="wrapper">
<div class="flexcontainer noselect">
	<div class="flashdiv"></div>
	<div class="errordiv"><div class="errorflex"><div class="errormessage"></div></div></div>
	<div class="centerdiv">
		<div id = "jsondump"></div>


        <div class="ui">
            <div class="compassframe"><object id="compasses" data="svgs/compasses.svg" type="image/svg+xml" ></object></div>
			<div class="degrees"><span class="value">0</span><span class="mark">Â°</span></div>
        </div>
		
		<div class="targetdegree"></div>

		<div class = "nextbutton">&gt;</div>
<!--		<div class = "prevbutton">&lt;</div> -->

		<div class="debug"></div>
		<div class="debug2"></div>

	</div>
</div>
</div>
</body>
</html>




